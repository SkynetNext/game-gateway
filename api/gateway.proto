syntax = "proto3";

package gateway;

option go_package = "github.com/SkynetNext/game-gateway/api;gateway";
option csharp_namespace = "Game.Networking.Grpc";

// GameGatewayService handles communication between Gateway and GameServer
service GameGatewayService {
  // StreamPackets establishes a bidirectional stream for forwarding packets between Gateway and GameServer
  // Connection lifecycle events (connect/disconnect) are sent as GamePacket with metadata["packet_type"]
  rpc StreamPackets(stream GamePacket) returns (stream GamePacket);
}

// GamePacket is a generic packet envelope for Gateway and GameServer communication
message GamePacket {
  // SessionID uniquely identifies a client connection on Gateway side
  int64 session_id = 1;

  // MsgID is the original message ID (corresponds to Protobuf message type)
  // For normal game messages, this is the actual message ID
  // For connection lifecycle events, this field is ignored (use metadata instead)
  int32 msg_id = 2;

  // Payload contains the original message body binary data (passthrough, no re-serialization)
  // Empty for connection/disconnection events
  bytes payload = 3;
  
  // Metadata is used for extended fields like TraceContext and packet type
  // For connection lifecycle events, metadata must contain:
  //   - "packet_type": "connect", "disconnect", "server_connect", or "server_disconnect"
  //   - For "connect" (Gateway → GameServer): "client_ip", "protocol", "connect_time" (Unix milliseconds)
  //     Note: gateway-name is obtained from gRPC header during stream establishment, not from packet metadata
  //   - For "disconnect" (Gateway → GameServer, client-initiated): "reason", "disconnect_time" (Unix milliseconds)
  //   - For "server_connect" (GameServer → Gateway, login accepted): "reason", "connect_time" (Unix milliseconds)
  //   - For "server_disconnect" (GameServer → Gateway, server-initiated): "reason", "disconnect_time" (Unix milliseconds)
  // For normal game messages, metadata may contain:
  //   - "trace_id": OpenTelemetry trace ID
  //   - "span_id": OpenTelemetry span ID
  map<string, string> metadata = 4;

  // For broadcast: if this field has values, session_id is ignored and message is broadcast to all listed sessions
  repeated int64 target_session_ids = 5;
}
